classdef ODIN_machine_design < handle
	properties
		machine_data = {
%			machine id   |  speeds of machine | reference control data |  active	|  loss
%  		{'I04_Vol02_version01'		2			{26,164,70}					0		{746.9170083	355.5381209	546.389292	271.0207066	400.5809352}}...% -> 4phase 2PolePair
%   		{'I08_Vol02_version02'		2			{25,145,120}				0		{369.7425431	397.2972058	303.1955482	199.0649966	363.4866094}}...%-> 3phase 3PolePair
% 	  	{'I07_Vol02'				2			{50,169,65}					0		{367.5407384	137.5083238	211.5337457	107.4137697	326.0762496}}...% -> 3phase 2PolePair
%  		{'I03_Vol02'				2			{40,165,65}					1		{561.1395573	128.092552	197.3787614	132.9151072	249.9783189}}...% -> 4phase 1PolePair
  		{'I06_Vol03_version06'		1			{35,170,110}				0		{443.6982873	401.5941163	334.3562073	231.361585	344.7377044}}...%{1 1 1 1 1}}...% -> 3Phase 3PolePair 1Speed
%   		{'I02_Vol01'				1			{35,165,85}					0		{939.1996808	400.9674179	491.2429218	279.3459043	530.6253675}}... % 
%   		{'I05_Vol01'				1			{50,165,70}					0		{421.1728149	176.0113032	239.8951352	141.8072637	277.2519525}}... %
%   		{'I01_Vol01'				1			{40,170,65}					1		{564.4085691	153.616646	176.5768931	148.8079523	314.8463783}}... %
% 		{'I00_Vol01'				4			{40,160,60}					1		{}}...
% 		{'B02_Vol02'				3			{30,160,70}					1		{}}
		};
		begin_index_speed = 1;
		begin_index_torque = 1;
		obj_pc_srd_link
		str_root_design = 'T:\Forschung\LEA\7031_EU_ODIN_mhu\Intern\Data\WP2_Requirements_and_concept_development\aho_SRM_Designs\Designs';
		cell_speed
		cell_torque
		cell_operating_point
		cell_obj_srm
		cell_lptn
	end
	methods
		function obj = ODIN_machine_design
			addpath('D:\fqi\isea_drives_lib\LPN_Builder');
			obj.obj_pc_srd_link = General.clPCSRD_MatlabLink;
			obj.ChooseAllOperationPoint;
			obj.CalculateOperationPoint;
			obj.OutputToExcell;
% 			obj.BuildThermalModel;			
		end
		function InitCellOperatingPoint(obj,cell_operating_point)
			obj.cell_operating_point = cell_operating_point;
		end
	
		function cell_operating_point = CalculateOperationPoint(obj)
			for index = 1:numel(obj.machine_data)
				folder_path = [obj.str_root_design '\' obj.machine_data{index}{1}(1:3) '\' obj.machine_data{index}{1}(5:9) '\PC-SRD'];
				obj.cell_obj_srm{index} = General.clPC_SRD_Model(folder_path,obj.machine_data{index}{1});
				speeds_of_machine = obj.machine_data{index}{2};
				obj.obj_pc_srd_link.LoadModel(obj.cell_obj_srm{index});
				nr_speeds = length(obj.cell_speed{speeds_of_machine});
				for index_speed = obj.begin_index_speed:nr_speeds
					for index_torque = obj.begin_index_torque:length(obj.cell_torque{speeds_of_machine}{index_speed})
						obj.cell_obj_srm{index}.SetBasicControlParameter(obj.machine_data{index}{3}{:});
						obj.cell_operating_point{index}{index_speed}{index_torque} = obj.obj_pc_srd_link.FindBestEffForOperatingPoint(obj.cell_speed{speeds_of_machine}{index_speed},obj.cell_torque{speeds_of_machine}{index_speed}(index_torque));
					end
				end
			end
			cell_operating_point = obj.cell_operating_point;
		end
		function BuildThermalModel(obj)
			for index = 1:numel(obj.machine_data)
				folder_path = [obj.str_root_design '\' obj.machine_data{index}{1}(1:3) '\' obj.machine_data{index}{1}(5:9) '\PC-SRD'];
				cell_obj_srm{index} = General.clPC_SRD_Model(folder_path,obj.machine_data{index}{1});
				obj.cell_lptn{index} = Motor.clSRM_LPTN;
				obj.cell_lptn{index}.SetPC_SRDModel(cell_obj_srm{index});
% 				obj.machine_data{index}{1}
% 				1/obj.cell_lptn{index}.obj_SRM_geometry.GetStatorOutsideArea+...
% 				1/obj.cell_lptn{index}.obj_SRM_geometry.GetWindingStatorContactArea
				obj.cell_lptn{index}.SetSRMType(0,1);
				obj.cell_lptn{index}.SetResolution({2,2,2},{2,2,2});
				obj.cell_lptn{index}.SetOptions(LPNEnum.enumLPNBuilderOption.use_symbolic_representation,LPNEnum.enumLPNBuilderOption.output_as_to_workspace,LPNEnum.enumLPNBuilderOption.simulation_steady_state);
				obj.cell_lptn{index}.ConstructMachine;
				obj.cell_lptn{index}.SetLoss(obj.machine_data{index}{5}{:});
				obj.cell_lptn{index}.BuildMachineLPTN;
% 				obj.cell_lptn{index}.StartSimulation;
			end
		end
		function OutputToExcell(obj,cell_result)
			if nargin == 1
				cell_result = obj.cell_operating_point;
			end
			run([pwd '\wsrd32params.m']);
			load('I01_I08_all_operation_point.mat');
			for index_model = 1:numel(cell_result)
				nr_operating_point = 0;
				str_name = obj.cell_operating_point{index_model}{1}{1}{1};
				if numel(obj.cell_operating_point{index_model}) == 4
					Nr_operation_point = [6 2 9 8 10 3 4 7 1 5];
				else
					Nr_operation_point = [12 16 19 2 6 9 13 14 18 20 3 4 8 10 11 17 15 1 7 5];
				end
				operating_point={'Nr',...
					'Torque',...
					'Speed',...
					'Th0 - Turn-on angle(eDeg)',...
					'ThC - Turn-off angle(eDeg)',...
					'iHi - Current limit(A)',...
					'HBAmps - Hysteresis Band(A)',...
					'Efficiency(%)',...
					'Jrms - Winding current density(A/mm^2)',...
					'fChopAvg - Mean chopping frequency over a complete cycle(kHz)',...
					'fChopAct - Chopping frequency averaged over conduction angle(kHz)',...
					'Iron Loss Stator',...
					'Iron Loss Rotor',...
					'Copper Loss'};
				for index_speed = 1:numel(obj.cell_operating_point{index_model})	
					for index_torque = 1:numel(cell_result{index_model}{index_speed})
						nr_operating_point = nr_operating_point+1;
						%name = cell_result{index_model}{index_speed}{index_torque}{1};
						operating_point=[ operating_point;...
						{
						Nr_operation_point(nr_operating_point),...
						cell_result{index_model}{index_speed}{index_torque}{piTORQSH},...
						cell_result{index_model}{index_speed}{index_torque}{piRPM},...
						cell_result{index_model}{index_speed}{index_torque}{piTH0},...
						cell_result{index_model}{index_speed}{index_torque}{piTHC},...
						cell_result{index_model}{index_speed}{index_torque}{piIHI},...
						cell_result{index_model}{index_speed}{index_torque}{piHB},...
						cell_result{index_model}{index_speed}{index_torque}{piEFF}/100,...
						cell_result{index_model}{index_speed}{index_torque}{piJRMS},...
						cell_result{index_model}{index_speed}{index_torque}{piFCHOPAVG},...
						cell_result{index_model}{index_speed}{index_torque}{piFCHOPACT}...
						cell_result{index_model}{index_speed}{index_torque}{piPSYH}+...
							cell_result{index_model}{index_speed}{index_torque}{piPSYE}+...
							cell_result{index_model}{index_speed}{index_torque}{piPSPH}+...
							cell_result{index_model}{index_speed}{index_torque}{piPSPE},...
						cell_result{index_model}{index_speed}{index_torque}{piPRYH}+...
							cell_result{index_model}{index_speed}{index_torque}{piPRYE}+...
							cell_result{index_model}{index_speed}{index_torque}{piPRPH}+...
							cell_result{index_model}{index_speed}{index_torque}{piPRPE},...
						cell_result{index_model}{index_speed}{index_torque}{piWCU}...
			% 			cell_result{index_model}{index_speed}{index_torque}{piFCHOPAVG},...
			%  			cell_result{index_model}{index_speed}{index_torque}{piFCHOPAVG},...
			%  			cell_result{index_model}{index_speed}{index_torque}{piFCHOPAVG},...
							}];

					end
				end
				xlswrite([date '_ODIN_SRM_Operating_Point.xls'], operating_point,str_name);
			end
			
				
		end
		function ChooseAllOperationPoint(obj)
			%operating points for 1 speed
			obj.cell_speed{1} = {...
				[1365]...
				,[4095]...
				,[6825]...
				,[9555]...
				};
			obj.cell_torque{1} = {...
				[-20.6 , 6.9 , 34.3]...
				,[-20.6 , 6.9 , 20.6 , 34.3]...
				,[6.9 , 20.6]...
				,[6.9]...
				};
			%operating points for 2 speeds
			obj.cell_speed{2} = {...
				[1172]...
				,[1875]...
				,[3516]...
				,[5625]...
				,[5859]...
				,[8203]...
				,[9375]...
				,[13125]...
				};
			obj.cell_torque{2} = {...
				[8,-24,40]...
				,[5,-15,25]...
				,[24,40,-24,8]...
				,[15,25,-15,5]...
				,[24,8]...
				,[8]...
				,[15,5]...
				,[5]...
				};
			%operating points(for machines designed to run at maximal 15000 with the same power)
			obj.cell_speed{3} = {...
				[1365*15000/22500]...
				,[4095*15000/22500]...
				,[6825*15000/22500]...
				,[9555*15000/22500]...
				};
			obj.cell_torque{3} = {...
				[-20.6 , 6.9 , 34.3]*22500/15000 ...
				,[-20.6 , 6.9 , 20.6 , 34.3]*22500/15000 ...
				,[6.9 , 20.6]*22500/15000 ...
				,[6.9]*22500/15000 ...
				};
			%operating points(for machines designed to run at maximal 15000 with the reduced power)
			obj.cell_speed{4} = {...
				[1365*15000/22500]...
				,[4095*15000/22500]...
				,[6825*15000/22500]...
				,[9555*15000/22500]...
				};
			obj.cell_torque{4} = {...
				[-20.6 , 6.9 , 34.3]*22500/15000*14/16 ...
				,[-20.6 , 6.9 , 20.6 , 34.3]*22500/15000*14/16 ...
				,[6.9 , 20.6]*22500/15000*14/16 ...
				,[6.9]*22500/15000*14/16 ...
				};
		end
	end
end